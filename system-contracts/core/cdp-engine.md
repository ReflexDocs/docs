---
description: 'The CDP, system coin and collateral database'
---

# CDP Engine

## 1. Summary <a id="1-introduction-summary"></a>

The `CDPEngine` stores CDPs and tracks all debt and collateral balances. This contract is the most important system component and thus, in order to minimize the possibility of bugs, it does not have any external dependencies.

## 2. Contract Variables & Functions <a id="2-contract-details"></a>

**Variables**

* `debtBalance[user: address]` - unbacked coins \(system debt, not belonging to any `cdp`\).
* `collateralTypes[collateralType: bytes32]` - a mapping of `CollateralType`s.
* `cdps[collateralType: bytes32`, `cdpHandler: address]` - a mapping of `CDP` types.
* `tokenCollateral[user: address]` - collateral token balances.
* `coinBalance[user: address]` - how many coins \(bonds\) an account has. This number is **not** reflected in the [external token contract](https://reflexer-labs.gitbook.io/geb/system-contracts/token-module/system-coin).
* `globalDebt` - total amount of debt currently issued.
* `globalDebtCeiling` - the limit on total amount of debt that can be issued.
* `globalUnbackedDebt` - amount of 'bad' debt in the system.
* `authorizedAccounts[usr: address]` - stores addresses that are able to `modifyParameters`,  disable the contract, `modifyCollateralBalance`s, `createUnbackedDebt` and `confiscateCDPCollateralAndDebt`.
* `contractEnabled` - global settlement flag.

**Data Structures**

* `CollateralType`:
  * `debtAmount` - total normalized system coin debt.
  * `accumulatedRate` - system coin debt multiplier \(accumulated stability fees\).
  * `safetyPrice` - collateral price with safety margin. Used to limit the amount of debt that can be generated per one unit of collateral.
  * `debtCeiling` - the total amount of debt that can be generated using this collateral type.
  * `debtFloor` - the minimum amount of debt that must be generated by a CDP with this collateral type.
  * `liquidationPrice` - collateral price with safety margin. Used only in `LiquidationEngine` when a CDP is liquidated.
* `CDP`:
  * `lockedCollateral` - CDP collateral balance.
  * `generatedDebt` - normalized outstanding system coin debt.

**Modifiers**

* `canModifyCDP` - modifier that checks whether an address is allowed to modify another address's collateral or system coin balance.
* `isAuthorized` ****- checks whether an address is part of `authorizedAddresses`.

**Functions**

* `disableContract()` - disable the CDPEngine.
* `modifyParameters(parameter: bytes32`, `data: uint256)` - modify general `uint256` parameters.
* `modifyParameters(collateralType: bytes32`, `parameter: bytes32`, `data: uint256)` - modify collateral type `uint256` parameters.
* `initializeCollateralType(collateralType: bytes32)` - create a new collateral type.
* `modifyCollateralBalance(parameter: bytes32`, `usr: address`, `wad: int256)` - modify a user's collateral balance.
* `transferCollateral(collateralType: bytes32`, `src: address`, `dst: address`, `wad: uint256)` - transfer collateral between users.
* `transferInternalCoins(src: address`, `dst: address`, `rad: uint256)` - transfer system coins between users. This action does not transfer coins between users in the ERC20 contract but only in the CDPEngine.
* `confiscateCDPCollateralAndDebt(collateralType: bytes32`,`cdp: address`, `collateralCounterparty: address`, `debtCounterparty: address`, `deltaCollateral: int256`, `deltaDebt: int256)` - called by the `LiquidationEngine` when auctioning collateral to cover bad debt.
* `settleDebt(rad: uint256)` - destroy equal quantities of system coins and system debt \(`globalUnbackedDebt`\).
* `updateAccumulatedRate(collateralType: bytes32`, `surplusDst: address`, `rateMultiplier: int256)` - modify a collateral's accumulated interest rates, creating / destroying corresponding debt.
* `createUnbackedDebt(debtDestination: address`, `coinDestination: address`, `rad: uint256)` - mint unbacked system coins \(accounted for with `globalUnbackedDebt`\).
* `modifyCDPCollateralization(collateralType: bytes32`, `cdp: address`, `collateralSource: address`, `debtDestination: address`, `deltaCollateral: int256`, `deltaDebt: int256)` - modify a CDP's CRatio ****by locking/unlocking collateral and/or generating/paying back debt.
* `transferCDPCollateralAndDebt(collateralType: bytes32`, `src: address`, `dst: address`, `deltaCollateral: int256`, `deltaDebt: int256)` - splitting/merging CDPs by transferring collateral and/or debt between them.
* `approveCDPModification(account: address)` - enable `canModifyCDP`for a pair of addresses.
* `denyCDPModification(account: address)` - disable `canModifyCDP`for a pair of addresses.

**Notes**: 

* `globalDebt` equals `globalUnbackedDebt` plus the sum of `CollateralType.debtAmount * CollateralType.accumulatedRates` across all `collateralTypes`.
* `globalUnbackedDebt` is the sum of all `debtBalance`s \(the total quantity of system debt\).
* `CollateralType.debtAmount` the sum of all `generatedDebt` in the `cdp`s for that `CollateralType`.

## 3. Walkthrough <a id="3-mechanisms-and-concepts"></a>

The `CDPEngine` is in charge with two main system functions:

### 1. CDP Management <a id="vault-management"></a>

* Anyone can manage a CDP via `modifyCDPCollateralization`, which modifies the CDP at address `cdp`, using `tokenCollateral` from user `collateralSource` and modifying `coinBalance` for user `debtDestination`.
* `confiscateCDPCollateralAndDebt`is usually called by `LiquidationEngine` and transfers debt from the CDP to another address' `debtBalance`.
* `debtBalance` represents "bad" debt and can be canceled out with an equal quantity of system coins using `settleDebt(uint rad)` where `msg.sender` is used as the address for the `coinBalance` and `debtBalance`.

### **2. Stability Fee Accrual** <a id="rate-updates-via-fold-bytes32-ilk-address-u-int-rate"></a>

The `accumulatedRates` helps convert normalized debt \(`generatedDebt`\) drawn against a `collateralType` to the present value of that debt \(actual debt issued + interest\). The rate is updated using `updateAccumulatedRate` \(called by the `TaxCollector`\). After every update, the newly accrued stability fees are added to the `coinBalance` of `surplusDst`.

