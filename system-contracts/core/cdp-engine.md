---
description: 'The CDP, system coin and collateral database'
---

# CDP Engine

## 1. Summary <a id="1-introduction-summary"></a>

The `CDPEngine` stores CDPs and tracks all debt and collateral balances. This contract is the most important system component and thus, in order to minimize the possibility of bugs, it does not have any external dependencies.

## 2. Contract Variables & Functions <a id="2-contract-details"></a>

* `tokenCollateral[user: address]`: collateral token balances.
* `coinBalance[user: address]`: how many coins \(bonds\) an account has. This number is **not** reflected in the [external token contract](https://reflexer-labs.gitbook.io/geb/system-contracts/token-module/system-coin).
* `debtBalance[user: address]`: unbacked coins \(system debt, not belonging to any `cdp`\).
* `collateralTypes`: a mapping of `CollateralType`s.
* `CollateralType`:
  * `debtAmount`: total normalized system coin debt.
  * `accumulatedRates`: system coin debt multiplier \(accumulated stability fees\).
  * `safetyPrice`: collateral price with safety margin. Used to limit the amount of debt that can be generated per one unit of collateral.
  * `debtCeiling`: the total amount of debt that can be generated using this collateral type.
  * `debtFloor`: the minimum amount of debt that must be generated by a CDP with this collateral type.
  * `liquidationPrice`: collateral price with safety margin. Used only in `LiquidationEngine` when a CDP is liquidated.
* `cdps`: a mapping of `CDP` types.
* `CDP`:
  * `lockedCollateral`: CDP collateral balance.
  * `generatedDebt`: normalized outstanding system coin debt.
* `initializeCollateralType`: create a new collateral type.
* `modifyCollateralBalance`: modify a user's collateral balance.
* `transferCollateral`: transfer collateral between users.
* `transferInternalCoins`: transfer system coins between users. This action does not transfer coins between users in the ERC20 contract but only in the CDPEngine.
* `confiscateCDPCollateralAndDebt(collateralType: bytes32`,`cdp: address`, `collateralCounterparty: address`, `debtCounterparty: address`, `deltaCollateral: int256`, `deltaDebt: int256)`: called by the `LiquidationEngine` when auctioning collateral to cover bad debt.
* `settleDebt`: destroy equal quantities of system coins and system debt \(`globalUnbackedDebt`\).
* `updateAccumulatedRate`: modify a collateral's accumulated interest rates, creating / destroying corresponding debt.
* `createUnbackedDebt`: mint unbacked system coins \(accounted for with `globalUnbackedDebt`\).
* `globalDebtCeiling`: the limit on total amount of debt that can be issued.
* `modifyCDPCollateralization`: modify a CDP's CRatio.
  * `lock`: transfer collateral into a CDP.
  * `free`: transfer collateral out of a CDP.
  * `generateDebt`: increase CDP debt, creating system coins \(bonds\).
  * `repayAllDebt`: decrease CDP debt, destroying system coins \(bonds\).
  * `deltaCollateral`: change in a CDP's collateral.
  * `deltaDebt`: change in a CDP's debt.
* `transferCDPCollateralAndDebt`: splitting/merging CDPs by transferring collateral and/or debt between them.
  * `deltaCollateral`: amount of collateral to exchange.
  * `deltaDebt`: amount of system coin debt to exchange.
* `canModifyCDP`: check whether an address is allowed to modify another address's collateral or system coin balance.
  * `approveCDPModification`: enable `canModifyCDP`for a pair of addresses.
  * `denyCDPModification`: disable `canModifyCDP`for a pair of addresses.
* `globalDebt` is the sum of all `coinBalance`s \(the total quantity of system coins issued\).
* `globalUnbackedDebt` is the sum of all `debtBalance`s \(the total quantity of system debt\).
* `CollateralType.debtAmount` the sum of all `generatedDebt` in the `cdp`s for that `CollateralType`.

**Note**: `globalDebt` equals `globalUnbackedDebt` plus the sum of `CollateralType.debtAmount * CollateralType.accumulatedRates` across all `collateralTypes`.

## 3. Walkthrough <a id="3-mechanisms-and-concepts"></a>

The `CDPEngine` is in charge with two main system functions:

### 1. CDP Management <a id="vault-management"></a>

* Anyone can manage a CDP via `modifyCDPCollateralization`, which modifies the CDP at address `cdp`, using `tokenCollateral` from user `collateralSource` and modifying `coinBalance` for user `debtDestination`.
* `confiscateCDPCollateralAndDebt`is usually called by `LiquidationEngine` and transfers debt from the CDP to another address' `debtBalance`.
* `debtBalance` represents "bad" debt and can be canceled out with an equal quantity of system coins using `settleDebt(uint rad)` where `msg.sender` is used as the address for the `coinBalance` and `debtBalance`.

### **2. Stability Fee Accrual** <a id="rate-updates-via-fold-bytes32-ilk-address-u-int-rate"></a>

The `accumulatedRates` helps convert normalized debt \(`generatedDebt`\) drawn against a `collateralType` to the present value of that debt \(actual debt issued + interest\). The rate is updated using `updateAccumulatedRate` \(called by the `TaxCollector`\). After every update, the newly accrued stability fees are added to the `coinBalance` of `surplusDst`.

